<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Compass Logistics Chatbot</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="chat-wrapper">
    <header>
      <img src="https://www.compasslog.com/img/compass-logo.png" alt="Compass Logo" class="logo">
      <h1>Compass Logistics Assistant</h1>
      <p>Ask anything about Compass Logistics International</p>
    </header>

    <main id="chat-box" class="chat-box"></main>

    <div class="input-section">
      <input id="user-input" type="text" placeholder="Type your question..." autofocus>
      <button id="send-btn">Send ðŸš€</button>
      <button id="clear-btn" title="Clear chat">ðŸ—‘</button>
    </div>
  </div>

  <script>
    const input = document.getElementById("user-input");
    const chatBox = document.getElementById("chat-box");
    const sendBtn = document.getElementById("send-btn");
    const clearBtn = document.getElementById("clear-btn");

    function appendMessage(sender, text, id=null) {
      const msg = document.createElement("div");
      msg.className = sender === "user" ? "msg user" : "msg bot";
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = marked.parse(text || "");
      if (id) bubble.id = id;
      msg.appendChild(bubble);
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;

      appendMessage("user", text);
      input.value = "";
      input.focus();

      const msgId = "bot-msg-" + Date.now();
      appendMessage("bot", " ", msgId);

      const eventSource = new EventSourcePolyfill("/chat/stream", {
        headers: { "Content-Type": "application/json" },
        payload: JSON.stringify({ message: text }),
        method: "POST",
      });

      let reply = "";
      const bubble = document.getElementById(msgId);

      eventSource.onmessage = (event) => {
        if (event.data === "[DONE]") {
          eventSource.close();
          return;
        } else if (event.data.startsWith("[ERROR]")) {
          bubble.innerHTML = "âš ï¸ Error: " + event.data.slice(7);
          eventSource.close();
          return;
        }
        reply += event.data;
        bubble.innerHTML = marked.parse(reply);
        chatBox.scrollTop = chatBox.scrollHeight;
      };
    }

    async function clearChat() {
      await fetch("/clear", { method: "POST" });
      chatBox.innerHTML = "";
      appendMessage("bot", "ðŸ§¹ Chat cleared!");
    }

    sendBtn.addEventListener("click", sendMessage);
    clearBtn.addEventListener("click", clearChat);
    input.addEventListener("keypress", e => { if (e.key === "Enter") sendMessage(); });

    // Show greeting on load
    appendMessage("bot", "ðŸ‘‹ Hi! I'm CompassBot. Ask me anything about Compass Logistics International.");

    // Polyfill for EventSource POST (since native doesn't support POST)
    class EventSourcePolyfill {
      constructor(url, options = {}) {
        this.eventSource = null;
        const { headers, payload, method } = options;
        fetch(url, {
          method: method || "POST",
          headers: headers || {},
          body: payload || null,
        }).then(async res => {
          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value);
            chunk.split("\n\n").forEach(line => {
              if (line.startsWith("data:")) {
                const event = { data: line.slice(5).trim() };
                if (this.onmessage) this.onmessage(event);
              }
            });
          }
        });
      }
      close() {
        this.eventSource?.close?.();
      }
    }
  </script>
</body>
</html>
